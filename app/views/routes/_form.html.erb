<%= form_for @route, :html => { :class => "form-inline" } do |f| %>
  <% if @route.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@route.errors.count, "error") %> prohibited this route from being saved:</h2>

      <ul>
      <% @route.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <% index = 0 %>
  <%= f.fields_for :locations do |l| %>
    <% index += 1 %>
    <legend>Location <%= index %></legend>
    <div class="field">
      <%= l.label "name" %>
      <%= l.text_field :name %>
      <%= l.label "address" %>
      <%= l.text_field :address_string, :class => "input-xxlarge" %>
      <span class="verified"></span>
    </div>

  <% end %>

  <div id="change_address" class="change-address modal hide fade">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
      <h3 id="myModalLabel">Modal header</h3>
    </div>
    <div class="modal-body">
      <p class="address"></p>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      <button class="btn btn-primary">Use Verified Address</button>
    </div>
  </div>

  <br />

  <div class="actions">
    <%= link_to "Verify My Addresses", "javascript:void(0)", :class => "btn", :id => "verify_addresses" %>
    <%= f.submit "Create My Route", :class => "btn btn-primary" %>
  </div>
<% end %>

<script type="text/javascript">
  $("a#verify_addresses").click(function(event) {
    $.ajax({
      url: "<%= verify_collection_locations_path %>",
      type: "POST",
      data: $("form").serialize()
    }).done(function(data) {
      jQuery.each(data, function(index, location) {
        var addressInput = $("#route_locations_attributes_"+location.index+"_address_string");
        if (location.verified) {
          $(addressInput).next("span.verified").html("valid");
        } else {
          $(addressInput).next("span.verified").html("suggested correction: " + location.verified_address);
        }
      });
    });
  });
</script>
